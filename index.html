<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <title>Bsoft TMS AI Chat - V5 Stable</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-glass: rgba(255, 255, 255, 0.96);
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.15);
            --radius: 16px;
        }

        body {
            font-family: 'Segoe UI', Inter, system-ui, sans-serif;
            margin: 0; padding: 0;
            background-color: #f0f2f5;
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url("https://bsoft.com.br/blog/wp-content/uploads/2025/03/bsoft-960x500.webp");
            background-repeat: no-repeat; background-size: cover; background-attachment: fixed; background-position: center;
            height: 100vh; display: flex; justify-content: center; align-items: center;
        }

        .main-container {
            background-color: var(--bg-glass);
            width: 100%; max-width: 900px; height: 95vh;
            border-radius: var(--radius); box-shadow: var(--shadow);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* Header */
        header {
            padding: 15px 20px; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.95); z-index: 10;
        }
        h1 { margin: 0; font-size: 18px; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        .badge { font-size: 11px; background:#dcfce7; color:#166534; padding:3px 8px; border-radius:12px; font-weight: bold; }

        /* Chat Stream */
        #chatStream {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 15px;
            background-color: #f8fafc; scroll-behavior: smooth;
        }

        /* Bal√µes */
        .message {
            max-width: 85%; padding: 12px 16px; border-radius: 12px;
            line-height: 1.5; font-size: 15px; position: relative; word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }
        .user-msg {
            align-self: flex-end; background-color: var(--primary-color);
            color: white; border-bottom-right-radius: 2px; box-shadow: 0 2px 5px rgba(37,99,235,0.2);
        }
        .ai-msg {
            align-self: flex-start; background-color: white;
            color: #1e293b; border: 1px solid #e2e8f0; border-bottom-left-radius: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Card Retr√°til (Resultados) */
        .db-result-card {
            align-self: center; width: 95%; max-width: 600px;
            background-color: #fffbeb; border: 1px solid #fcd34d;
            border-radius: 8px; overflow: hidden; margin: 5px 0;
            animation: fadeIn 0.4s ease;
        }
        .db-header-btn {
            width: 100%; padding: 12px 15px; background: none; border: none;
            text-align: left; font-weight: 600; color: #92400e; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s;
        }
        .db-header-btn:hover { background-color: #fef3c7; }
        .db-content { display: none; padding: 15px; border-top: 1px solid #fcd34d; background-color: #fff; max-height: 400px; overflow-y: auto; }
        
        .result-item {
            background: #fafafa; padding: 12px; border-left: 4px solid #f59e0b;
            margin-bottom: 10px; border-radius: 4px; font-size: 14px; color: #334155;
        }

        /* Input Area */
        .input-area {
            padding: 20px; background: white; border-top: 1px solid #e2e8f0;
            display: flex; gap: 10px; align-items: center;
        }
        #searchInput { 
            flex: 1; padding: 12px 15px; border: 2px solid #e2e8f0; 
            border-radius: 24px; font-size: 15px; outline: none; transition: 0.2s;
        }
        #searchInput:focus { border-color: var(--primary-color); }
        .send-btn { 
            width: 45px; height: 45px; background: var(--primary-color); color: white; 
            border: none; border-radius: 50%; cursor: pointer; font-size: 18px;
            display: flex; justify-content: center; align-items: center; transition: 0.2s;
        }
        .send-btn:hover { transform: scale(1.05); background: var(--primary-hover); }

        /* Termos sugeridos */
        .suggestions { padding: 8px 20px; background: #f1f5f9; font-size: 12px; white-space: nowrap; overflow-x: auto; border-top: 1px solid #e2e8f0; }
        .suggestions span { margin-right: 10px; color: #64748b; }
        .suggestions a { color: #2563eb; text-decoration: none; cursor: pointer; margin-right: 8px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="main-container">
    <header>
        <h1>ü§ñ Suporte Bsoft <span class="badge">Online</span></h1>
        <button onclick="checkPassword()" style="border:none; background:none; cursor:pointer; font-size:18px;">üîë</button>
    </header>

    <div id="chatStream">
        <div class="message ai-msg">
            Ol√°! Sou o assistente Bsoft. <br>
            Posso ajudar com erros do sistema, manuais ou d√∫vidas t√©cnicas. <br>
            <b>Qual √© a situa√ß√£o?</b>
        </div>
    </div>

    <div class="suggestions" id="topTermsBar">
        <span>Em alta:</span> 
        <a onclick="fillAndSend('CT-e sem averba√ß√£o')">CT-e Averba√ß√£o</a>
        <a onclick="fillAndSend('Erro de valida√ß√£o')">Erro Valida√ß√£o</a>
        <a onclick="fillAndSend('MDF-e Encerrado')">MDF-e</a>
    </div>

    <div class="input-area">
        <input type="text" id="searchInput" placeholder="Digite sua d√∫vida..." autofocus>
        <button class="send-btn" onclick="handleChat()">‚û§</button>
    </div>
</div>

<script>
    // --- CONFIGURA√á√ïES ---
    const GITHUB_RAW_URL = "https://raw.githubusercontent.com/lucasborgescamargo1994-blip/Pessoal/main/banco_dados.txt.txt";
    const GITHUB_PAGE_URL = "https://github.com/lucasborgescamargo1994-blip/Pessoal/blob/main/banco_dados.txt.txt";
    const GEMINI_API_KEY = "AIzaSyBUJ43suRdhmhfdr6RNncMsMPySv7d2nj8"; 
    const CORRECT_PASSWORD = "camargo02";

    let fileContent = "";
    let chatHistory = []; // Mem√≥ria da conversa

    // Sin√¥nimos (COPIADO DA SUA L√ìGICA FUNCIONAL)
    const SINONIMOS = {
        "imprimir": ["gerar", "emitir", "visualizar", "danfe", "dacte", "damdf"],
        "gerar": ["emitir", "fazer", "imprimir", "criar"],
        "averba√ß√£o": ["averbar", "seguro", "atm", "porto seguro"],
        "ct-e": ["cte", "conhecimento", "transporte"],
        "mdf-e": ["mdfe", "manifesto"],
        "cancelar": ["estornar", "anular", "inutilizar"],
        "pagamento": ["financeiro", "baixa", "receber", "contas"],
        "cliente": ["remetente", "destinat√°rio", "tomador"]
    };

    // --- INICIALIZA√á√ÉO ---
    window.onload = () => {
        loadData();
        const input = document.getElementById('searchInput');
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleChat();
        });
        input.focus();
    };

    async function loadData() {
        try {
            const response = await fetch(`${GITHUB_RAW_URL}?t=${Date.now()}`);
            if (!response.ok) throw new Error("Erro GitHub");
            fileContent = await response.text();
            console.log("Banco carregado.");
        } catch (e) {
            appendMessage('ai', "‚ö†Ô∏è Erro ao carregar banco de dados. O sistema funcionar√° apenas com IA Gen√©rica.");
        }
    }

    // --- L√ìGICA DO CHAT (MISTURA DA UX NOVA COM A L√ìGICA ANTIGA) ---
    function handleChat() {
        const input = document.getElementById('searchInput');
        const query = input.value.trim();
        if (!query) return;

        // 1. Exibir mensagem do usu√°rio
        appendMessage('user', query);
        input.value = "";

        // 2. Executar L√≥gica de Busca Robusta (A SUA L√ìGICA)
        const results = searchDatabaseLogic(query);
        let contextForAI = "N√£o h√° dados espec√≠ficos no manual para esta d√∫vida.";

        // 3. Se houver resultados, cria o Card Retr√°til
        if (results.length > 0) {
            createRetractableResultCard(results);
            // Prepara texto para a IA
            contextForAI = results.slice(0, 4).map(r => r.block).join("\n---\n");
        }

        // 4. Chama a IA com Rota√ß√£o de Modelos
        askAIWithRotation(query, contextForAI);
    }

    // --- L√ìGICA DE BUSCA (A QUE FUNCIONA) ---
    function searchDatabaseLogic(query) {
        if (!fileContent) return [];
        
        const qLower = query.toLowerCase();
        const stopWords = ["como", "fazer", "o", "a", "de", "do", "da", "em", "para", "erro", "no", "na", "est√°", "com", "queria", "saber"];
        let searchTerms = qLower.split(' ').filter(word => !stopWords.includes(word) && word.length > 2);

        // Expans√£o de Termos
        let expandedTerms = [...searchTerms];
        searchTerms.forEach(term => {
            for (let chave in SINONIMOS) {
                if (term === chave || SINONIMOS[chave].includes(term)) {
                    expandedTerms.push(chave, ...SINONIMOS[chave]);
                }
            }
        });
        expandedTerms = [...new Set(expandedTerms)];

        const blocks = fileContent.split('###');
        let scoredResults = [];

        blocks.forEach(block => {
            if (!block.trim()) return;
            let score = 0;
            const blockLower = block.toLowerCase();

            // Pontua√ß√£o Pesada (Igual ao seu c√≥digo)
            if (blockLower.includes(qLower)) score += 150;
            searchTerms.forEach(word => { if (blockLower.includes(word)) score += 40; });
            expandedTerms.forEach(word => { if (blockLower.includes(word)) score += 15; });

            if (score > 0) {
                scoredResults.push({ block, score });
            }
        });

        // Ordenar por score
        return scoredResults.sort((a, b) => b.score - a.score);
    }

    // --- FUN√á√ïES DE UI (Card e Bal√µes) ---
    function appendMessage(sender, text) {
        const stream = document.getElementById('chatStream');
        const div = document.createElement('div');
        div.className = `message ${sender === 'user' ? 'user-msg' : 'ai-msg'}`;
        div.innerHTML = text; 
        stream.appendChild(div);
        stream.scrollTop = stream.scrollHeight;
        return div; // Retorna para podermos editar depois (ex: loading)
    }

    function createRetractableResultCard(results) {
        const stream = document.getElementById('chatStream');
        const id = "res-" + Date.now();
        
        const div = document.createElement('div');
        div.className = "db-result-card";
        div.innerHTML = `
            <button class="db-header-btn" onclick="toggleResult('${id}')">
                <span>üîç Encontramos ${results.length} no manual t√©cnico</span>
                <span>‚ñº</span>
            </button>
            <div id="${id}" class="db-content">
                ${results.slice(0, 5).map(r => `
                    <div class="result-item">
                        ${formatBlock(r.block)}
                        <div style="font-size:10px; color:#94a3b8; text-align:right; margin-top:5px;">Precis√£o: ${r.score}</div>
                    </div>
                `).join('')}
            </div>
        `;
        stream.appendChild(div);
        stream.scrollTop = stream.scrollHeight;
    }

    function toggleResult(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function formatBlock(b) {
        return b.trim()
            .replace(/erro:/gi, '<strong style="color:#b45309">‚ùå ERRO:</strong>')
            .replace(/solu√ß√£o:/gi, '<br><strong style="color:#15803d">‚úÖ SOLU√á√ÉO:</strong>')
            .replace(/\n/g, ' ');
    }

    // --- IA COM ROTA√á√ÉO DE MODELOS (DO SEU C√ìDIGO) ---
    async function askAIWithRotation(question, context) {
        // Bal√£o de Loading
        const loadingDiv = appendMessage('ai', '<em>üß† Analisando manual e processando...</em>');

        // Lista de modelos (Do seu c√≥digo funcional)
        const modelosParaTentar = [
            "gemma-3-27b-it", 
            "gemini-2.0-flash-lite",
            "gemini-1.5-flash",
            "gemini-pro"
        ];

        // Hist√≥rico para Contexto (Limitado aos √∫ltimos 4 pares)
        const historyContext = chatHistory.slice(-4).map(h => `${h.role}: ${h.text}`).join('\n');

        async function tentarModelo(index) {
            if (index >= modelosParaTentar.length) {
                loadingDiv.innerHTML = "‚ùå Todos os modelos est√£o ocupados ou indispon√≠veis. Tente novamente.";
                return;
            }

            const MODELO_ATUAL = modelosParaTentar[index];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODELO_ATUAL}:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `
                            Voc√™ √© o Suporte Bsoft. 
                            Manual T√©cnico (prioridade m√°xima):
                            ${context}
                            
                            Hist√≥rico da conversa:
                            ${historyContext}
                            
                            Pergunta atual: ${question}
                            Responda de forma t√©cnica e amig√°vel.
                        `}] }]
                    })
                });

                const data = await response.json();

                if (!response.ok) throw new Error("Erro API");
                if (!data.candidates) throw new Error("Sem resposta");

                let aiText = data.candidates[0].content.parts[0].text;
                
                // Sucesso! Atualiza a mensagem de loading
                loadingDiv.innerHTML = aiText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

                // Salva no hist√≥rico
                chatHistory.push({ role: 'User', text: question });
                chatHistory.push({ role: 'AI', text: aiText });

            } catch (e) {
                console.warn(`Falha no modelo ${MODELO_ATUAL}, tentando pr√≥ximo...`);
                tentarModelo(index + 1); // Tenta o pr√≥ximo recursivamente
            }
        }

        // Inicia a tentativa
        tentarModelo(0);
    }

    // --- UTILS ---
    function checkPassword() {
        if (prompt("Senha:") === CORRECT_PASSWORD) window.open(GITHUB_PAGE_URL, '_blank');
    }
    
    function fillAndSend(txt) {
        document.getElementById('searchInput').value = txt;
        handleChat();
    }
</script>

</body>
</html>
